<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Parliament Diagram</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  svg text{font-family:system-ui,Arial,sans-serif}
  /* убираем стрелки у input type=number */
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
  input[type=number]{ -moz-appearance:textfield }
</style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center py-8">
  <h1 class="text-3xl font-bold mb-6">Interactive Parliament Diagram</h1>

  <!-- INPUT FORM -->
  <form id="inputForm" class="bg-white shadow-lg rounded-xl p-6 w-full max-w-4xl mb-10">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <label class="font-semibold flex flex-col">Total seats (1‑3000)
        <input type="number" id="totalSeats" class="border rounded p-1" min="1" max="3000" value="450" inputmode="numeric" />
      </label>
      <label class="font-semibold flex flex-col">Barrier % (0‑99)
        <input type="number" id="barrier" class="border rounded p-1" min="0" max="99" placeholder="0" inputmode="numeric" />
      </label>
    </div>
    <table class="w-full text-sm mb-4 border-collapse">
      <thead>
        <tr class="bg-slate-200"><th class="p-2">Party</th><th class="p-2">Votes</th><th class="p-2">Color</th></tr>
      </thead>
      <tbody id="partyTable"></tbody>
    </table>
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded px-4 py-2">Generate</button>
  </form>

  <!-- OUTPUT -->
  <div id="results" class="w-full max-w-7xl space-y-12"></div>

<script>
const defaultColors=['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999','#66c2a5'];
const tbody=document.getElementById('partyTable');
for(let i=0;i<10;i++){
  const row=document.createElement('tr');
  row.innerHTML=`<td class="border p-1"><input class="w-full border rounded p-1" placeholder="P${i+1}" /></td>
                 <td class="border p-1"><input type="number" class="w-full border rounded p-1" min="0" value="0" inputmode="numeric" /></td>
                 <td class="border p-1"><input type="color" value="${defaultColors[i]}" /></td>`;
  tbody.appendChild(row);
}

// ---------- quota helpers ----------
const hareQuota   =(V,S)=>V/S;
const droopQuota  =(V,S)=>Math.floor(V/(S+1))+1;
const imperialiQuota=(V,S)=>V/(S+2);

// ---------- largest remainder ----------
function largestRemainder(votes,seats,quotaFn){
  const totalVotes=votes.reduce((a,b)=>a+b,0);
  let quota=quotaFn(totalVotes,seats);
  let seatCounts=votes.map(v=>Math.floor(v/quota));
  let allocated=seatCounts.reduce((a,b)=>a+b,0);
  // handle over-allocation by iterative quota increase
  let scale=1.000001;
  while(allocated>seats){
    quota*=scale; seatCounts=votes.map(v=>Math.floor(v/quota));
    allocated=seatCounts.reduce((a,b)=>a+b,0); scale*=1.000001;
  }
  const remainders=votes.map((v,i)=>v-seatCounts[i]*quota);
  while(allocated<seats){
    let idx=0;
    for(let i=1;i<votes.length;i++){
      if(remainders[i]>remainders[idx]||
        (remainders[i]===remainders[idx]&&votes[i]>votes[idx])) idx=i;
    }
    seatCounts[idx]++; remainders[idx]-=quota; allocated++; }
  return seatCounts;}

// ---------- divisor method with heap ----------
class MaxHeap{constructor(){this.h=[]}
  push(o){this.h.push(o);this.up(this.h.length-1);}  up(i){while(i){const p=(i-1)>>1;if(this.h[p].val>=this.h[i].val)break;[this.h[p],this.h[i]]=[this.h[i],this.h[p]];i=p;}}
  pop(){if(!this.h.length)return null;const top=this.h[0];const last=this.h.pop();if(this.h.length){this.h[0]=last;this.down(0);}return top;}  down(i){for(;;){let l=i*2+1,r=l+1,b=i;if(l<this.h.length&&this.h[l].val>this.h[b].val)b=l;if(r<this.h.length&&this.h[r].val>this.h[b].val)b=r;if(b===i)break;[this.h[b],this.h[i]]=[this.h[i],this.h[b]];i=b;}}
}
function divisorMethod(votes,seats,divFn){
  const counts=Array(votes.length).fill(0);
  const heap=new MaxHeap();
  votes.forEach((v,i)=>heap.push({val:v/divFn(1),idx:i,div:1}));
  for(let s=0;s<seats;s++){
    const top=heap.pop(); counts[top.idx]++;
    const nextDiv=top.div+1;
    heap.push({val:votes[top.idx]/divFn(nextDiv),idx:top.idx,div:nextDiv});
  }
  return counts;}
const dHondtDiv=k=>k; const sainteLagueDiv=k=>2*k-1;

// ---------- SVG builder with transparent padding ----------
function buildSVG(title,counts,names,colors,seatR=6,gap=1,innerR=28){
  const total=counts.reduce((a,b)=>a+b,0);
  const partyObjs=counts.map((c,i)=>({c,color:colors[i],name:names[i]||`P${i+1}`})).filter(p=>p.c).sort((a,b)=>b.c-a.c);
  const coords=[];const visible=[];
  let remaining=total,row=0,rStep=seatR*2+gap,outerR=0;
  while(remaining>0){const radius=innerR+row*rStep+seatR;outerR=radius;
    const cap=Math.max(1,Math.floor(Math.PI*radius/(seatR*2+gap)));
    const seatsRow=Math.min(remaining,cap);
    for(let i=0;i<cap;i++){
      const theta=Math.PI-(i+0.5)*Math.PI/cap;
      coords.push([radius*Math.cos(theta),radius*Math.sin(theta)]);
      visible.push(i<seatsRow);
    }
    remaining-=seatsRow;row++; }
  const legendSpace=160;
  const w=Math.ceil(outerR*2+legendSpace+2*seatR+60);
  const h=innerR+row*rStep+90;
  const cx=outerR+30, cy=h-60;
  const svg=[`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">`];
  svg.push(`<text x="${legX+18}" y="${y}" alignment-baseline="middle" font-size="12" font-family="sans-serif">${p.name} – ${p.c}</text>`);
  });
  svg.push('</svg>');
  return svg.join('
');
}

// ---------- main ----------
const form = document.getElementById('inputForm');
form.addEventListener('submit', e => {
  e.preventDefault();
  const totalSeats = parseInt(document.getElementById('totalSeats').value);
  if (!(totalSeats >= 1 && totalSeats <= 3000)) {
    alert('Total seats must be between 1 and 3000');
    return;
  }
  const barrier = Math.min(Math.max(parseFloat(document.getElementById('barrier').value) || 0, 0), 99);
  const names = [...tbody.querySelectorAll('tr')].map(tr => tr.children[0].querySelector('input').value.trim());
  const votes = [...tbody.querySelectorAll('tr')].map(tr => Math.max(0, parseInt(tr.children[1].querySelector('input').value) || 0));
  const colors = [...tbody.querySelectorAll('tr')].map(tr => tr.children[2].querySelector('input').value);

  const totalVotes = votes.reduce((a, b) => a + b, 0);
  const thresh = totalVotes * barrier / 100;
  const votesFiltered = votes.map(v => v >= thresh ? v : 0);
  if (votesFiltered.reduce((a, b) => a + b, 0) === 0) {
    alert('No party passed the barrier');
    return;
  }

  const methods = [
    { name: 'Hare quota',      counts: largestRemainder(votesFiltered, totalSeats, hareQuota) },
    { name: 'Droop quota',     counts: largestRemainder(votesFiltered, totalSeats, droopQuota) },
    { name: 'Sainte-Laguë',    counts: divisorMethod(votesFiltered, totalSeats, sainteLagueDiv) },
    { name: "D'Hondt",        counts: divisorMethod(votesFiltered, totalSeats, dHondtDiv) },
    { name: 'Imperiali quota', counts: largestRemainder(votesFiltered, totalSeats, imperialiQuota) }
  ];

  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';
  methods.forEach(method => {
    const svgMarkup = buildSVG(method.name, method.counts, names, colors);
    const wrapper = document.createElement('div');
    wrapper.innerHTML = svgMarkup;
    resultsDiv.appendChild(wrapper);
  });
});
</script>
</body>
</html>

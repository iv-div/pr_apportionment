<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Parliament Diagram</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  svg text { font-family: system-ui, Arial, sans-serif; }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] {
    -moz-appearance: textfield;
  }
</style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center py-8">
  <h1 class="text-3xl font-bold mb-6">Interactive Parliament Diagram</h1>

  <form id="inputForm" class="bg-white shadow-lg rounded-xl p-6 w-full max-w-4xl mb-10">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <label class="font-semibold flex flex-col">Total seats
        <input type="number" id="totalSeats" class="border rounded p-1" min="1" max="3000" value="450" />
      </label>
      <label class="font-semibold flex flex-col">Barrier % (optional)
        <input type="number" id="barrier" class="border rounded p-1" min="0" max="99" placeholder="0" />
      </label>
      <label class="font-semibold flex flex-col">Tie-break strategy
        <select id="tieBreakStrategy" class="border rounded p-1">
          <option value="random" selected>Random (lot)</option>
          <option value="mostVotes">Party with most votes</option>
          <option value="leastVotes">Party with least votes</option>
          <option value="lowestIndex">Party with lowest index</option>
          <option value="disputed">Mark as disputed</option>
        </select>
      </label>
      <label class="font-semibold flex flex-col">Imperiali Over-Allocation
        <select id="imperialiStrategy" class="border rounded p-1">
          <option value="shrinkQuota" selected>Shrink quota (default)</option>
          <option value="increaseSeats">Increase seats</option>
        </select>
      </label>
    </div>
    <table class="w-full text-sm mb-4 border-collapse">
      <thead>
        <tr class="bg-slate-200"><th class="p-2">Party</th><th class="p-2">Votes</th><th class="p-2">Color</th><th class="p-2">Action</th></tr>
      </thead>
      <tbody id="partyTable"></tbody>
    </table>
    <div class="flex gap-4 mb-4">
      <button type="button" id="addParty" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded px-4 py-2">Add Party</button>
    </div>
    <div class="mb-4">
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold rounded text-lg px-6 py-3">Generate</button>
    </div>
  </form>

  <div id="results" class="w-full max-w-5xl space-y-12"></div>

  <script>
    const defaultColors = ['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999'];
    const tbody = document.getElementById('partyTable');

    function addPartyRow(index) {
      const row = document.createElement('tr');
      const colorIndex = index % defaultColors.length;
      row.innerHTML = `
        <td class="border p-1"><input class="w-full border rounded p-1" placeholder="P${index+1}" /></td>
        <td class="border p-1"><input type="number" class="w-full border rounded p-1" min="0" value="0" /></td>
        <td class="border p-1"><input type="color" value="${defaultColors[colorIndex]}" /></td>
        <td class="border p-1"><button type="button" class="remove-party text-gray-500 hover:text-gray-700 text-xl font-bold leading-none">&times;</button></td>`;
      tbody.appendChild(row);
      row.querySelector('.remove-party').addEventListener('click', function () {
        if (tbody.children.length > 1) row.remove();
      });
    }

    for (let i = 0; i < 5; i++) addPartyRow(i);

    document.getElementById('addParty').addEventListener('click', () => addPartyRow(tbody.children.length));

    const tieBreakers = {
      random: (c) => c[Math.floor(Math.random() * c.length)].index,
      mostVotes: (c) => c.reduce((a,b) => b.votes > a.votes ? b : a).index,
      leastVotes: (c) => c.reduce((a,b) => b.votes < a.votes ? b : a).index,
      lowestIndex: (c) => c.reduce((a,b) => b.index < a.index ? b : a).index,
      disputed: (c) => ({ disputed: true, between: c.map(x => x.index) })
    };

    function largestRemainder(votes, seats, quotaFn, tieBreaker) {
      const totalVotes = votes.reduce((a, b) => a + b, 0);
      const quota = quotaFn(totalVotes, seats);
      const base = votes.map(v => Math.floor(v / quota));
      const remainders = votes.map((v, i) => v - base[i] * quota);
      let allocated = base.reduce((a, b) => a + b, 0);
      const disputedSeats = [];

      while (allocated < seats) {
        const maxRem = Math.max(...remainders);
        const candidates = remainders.map((r, i) => ({ index: i, votes: votes[i], remainder: r })).filter(c => c.remainder === maxRem);
        const chosen = tieBreaker(candidates);
        if (typeof chosen === 'object' && chosen.disputed) {
          disputedSeats.push({ between: chosen.between });
          allocated++; 
        } else {
          base[chosen]++; remainders[chosen] = -1; allocated++;
        }
      }

      base.disputedSeats = disputedSeats;
      return base;
    }

    const hareQuota = (V, S) => V / S;
    const droopQuota = (V, S) => Math.floor(V / (S + 1)) + 1;
    const imperialiQuota = (V, S) => V / (S + 2);

    function fixOverAllocationShrinkQuota(votes, seats, quotaFn) {
      const totalVotes = votes.reduce((a, b) => a + b, 0);
      let quota = quotaFn(totalVotes, seats);
      let counts = votes.map(v => Math.floor(v / quota));
      let allocated = counts.reduce((a, b) => a + b, 0);
      let scale = 1.000001;
      while (allocated > seats) {
        quota *= scale;
        counts = votes.map(v => Math.floor(v / quota));
        allocated = counts.reduce((a, b) => a + b, 0);
        scale *= 1.000001;
      }
      return counts;
    }

    function fixOverAllocationIncreaseSeats(votes, seats, quotaFn) {
      const totalVotes = votes.reduce((a, b) => a + b, 0);
      let curSeats = seats;
      let quota = quotaFn(totalVotes, curSeats);
      let counts = votes.map(v => Math.floor(v / quota));
      while (counts.reduce((a, b) => a + b, 0) > seats) {
        curSeats++;
        quota = quotaFn(totalVotes, curSeats);
        counts = votes.map(v => Math.floor(v / quota));
      }
      return counts;
    }

    const form = document.getElementById('inputForm');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const totalSeats = parseInt(document.getElementById('totalSeats').value);
      const barrier = parseFloat(document.getElementById('barrier').value) || 0;
      const tieBreakStrategy = document.getElementById('tieBreakStrategy').value;
      const imperialiStrategy = document.getElementById('imperialiStrategy').value;
      const tieBreaker = tieBreakers[tieBreakStrategy];

      const data = [...tbody.querySelectorAll('tr')].map(tr => {
        return {
          name: tr.children[0].querySelector('input').value.trim() || 'Unnamed',
          votes: parseInt(tr.children[1].querySelector('input').value) || 0,
          color: tr.children[2].querySelector('input').value
        };
      }).filter(p => p.votes > 0);

      const totalVotes = data.reduce((sum, p) => sum + p.votes, 0);
      const threshold = totalVotes * barrier / 100;
      const filteredVotes = data.map(p => (p.votes >= threshold ? p.votes : 0));

      const imperiali = imperialiStrategy === 'increaseSeats' ? fixOverAllocationIncreaseSeats : fixOverAllocationShrinkQuota;

      const methods = [
        { name: 'Hare quota', result: largestRemainder(filteredVotes, totalSeats, hareQuota, tieBreaker) },
        { name: 'Droop quota', result: largestRemainder(filteredVotes, totalSeats, droopQuota, tieBreaker) },
        { name: 'Imperiali quota', result: imperiali(filteredVotes, totalSeats, imperialiQuota) }
      ];

      const results = document.getElementById('results');
      results.innerHTML = '';

      methods.forEach(method => {
        const wrapper = document.createElement('div');
        wrapper.className = 'bg-white p-4 rounded shadow';

        const title = document.createElement('h2');
        title.className = 'text-xl font-bold mb-2';
        title.textContent = method.name;
        wrapper.appendChild(title);

        const disputed = method.result.disputedSeats || [];
        const counts = method.result.filter((_, i) => i >= 0);

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', 600);
        svg.setAttribute('height', 300);
        svg.innerHTML = `
          <defs>
            <pattern id="disputedPattern" patternUnits="userSpaceOnUse" width="6" height="6">
              <path d="M0,0 l6,6 M-1,1 l2,-2 M5,7 l2,-2" stroke="black" stroke-width="1"/>
            </pattern>
          </defs>
        `;

        const radius = 12;
        const cxStart = 50;
        const cy = 150;
        let x = cxStart;

        counts.forEach((count, i) => {
          for (let j = 0; j < count; j++) {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', cy);
            circle.setAttribute('r', radius);
            circle.setAttribute('fill', data[i].color);
            circle.setAttribute('stroke', 'black');
            svg.appendChild(circle);
            x += 2 * radius + 4;
          }
        });

        disputed.forEach((entry, index) => {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', cy);
          circle.setAttribute('r', radius);
          circle.setAttribute('fill', 'url(#disputedPattern)');
          circle.setAttribute('stroke', 'black');
          circle.setAttribute('title', 'Disputed');
          svg.appendChild(circle);
          x += 2 * radius + 4;
        });

        wrapper.appendChild(svg);

        if (disputed.length > 0) {
          const p = document.createElement('p');
          p.className = 'text-red-600 mt-2';
          p.textContent = 'Disputed seats: ' + disputed.map(d => d.between.map(i => data[i].name).join(' vs ')).join('; ');
          wrapper.appendChild(p);
        }

        results.appendChild(wrapper);
      });
    });
  </script>
</body>
</html>

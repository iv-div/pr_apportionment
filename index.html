<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Parliament Diagram</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    svg text { font-family: system-ui, Arial, sans-serif }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center py-8">
  <h1 class="text-3xl font-bold mb-6">Interactive Parliament Diagram</h1>

  <form id="inputForm" class="bg-white shadow-lg rounded-xl p-6 w-full max-w-4xl mb-10">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <label class="font-semibold flex flex-col">Total seats
        <input type="number" id="totalSeats" class="border rounded p-1" min="1" max="3000" value="450" />
      </label>
      <label class="font-semibold flex flex-col">Barrier % (optional)
        <input type="number" id="barrier" class="border rounded p-1" min="0" max="99" placeholder="0" />
      </label>
    </div>

    <div class="mb-4">
      <label class="font-semibold flex flex-col">Tie-break rule
        <select id="tieBreakRuleSelect" class="border rounded p-1">
          <option value="disputed" selected>Leave as disputed (default)</option>
          <option value="random">Random (lot)</option>
          <option value="mostVotes">Party with most votes</option>
          <option value="leastVotes">Party with least votes</option>
          <option value="lowestIndex">Party with lowest index</option>
        </select>
      </label>
    </div>

    <table class="w-full text-sm mb-4 border-collapse">
      <thead>
        <tr class="bg-slate-200">
          <th class="p-2">Party</th>
          <th class="p-2">Votes</th>
          <th class="p-2">Color</th>
          <th class="p-2">Action</th>
        </tr>
      </thead>
      <tbody id="partyTable"></tbody>
    </table>
    <div class="flex gap-4 mb-4">
      <button type="button" id="addParty" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded px-4 py-2">Add Party</button>
    </div>
    <div class="mb-4">
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold rounded text-lg px-6 py-3">Generate</button>
    </div>
  </form>

  <div id="results" class="w-full max-w-5xl space-y-12"></div>

  <script>
    const defaultColors = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33'];
    const tbody = document.getElementById('partyTable');

    function addPartyRow(index) {
      const row = document.createElement('tr');
      const colorIndex = index % defaultColors.length;
      row.innerHTML = `<td class="border p-1"><input class="w-full border rounded p-1" placeholder="P${index + 1}" /></td>
                       <td class="border p-1"><input type="number" class="w-full border rounded p-1" min="0" value="0" /></td>
                       <td class="border p-1"><input type="color" value="${defaultColors[colorIndex]}" /></td>
                       <td class="border p-1"><button type="button" class="remove-party text-gray-500 hover:text-gray-700 text-xl font-bold leading-none">&times;</button></td>`;
      tbody.appendChild(row);
      row.querySelector('.remove-party').addEventListener('click', function () {
        if (tbody.children.length > 1) row.remove();
      });
    }

    for (let i = 0; i < 5; i++) addPartyRow(i);
    document.getElementById('addParty').addEventListener('click', () => addPartyRow(tbody.children.length));

    const tieBreakStrategies = {
      random: (tied, votes) => tied[Math.floor(Math.random() * tied.length)],
      mostVotes: (tied, votes) => tied.reduce((best, i) => votes[i] > votes[best] ? i : best, tied[0]),
      leastVotes: (tied, votes) => tied.reduce((best, i) => votes[i] < votes[best] ? i : best, tied[0]),
      lowestIndex: (tied) => Math.min(...tied),
      disputed: (tied, votes, disputeList, seatIndex) => {
        disputeList.push({ seatIndex, tiedBetween: tied });
        return 'DISPUTED';
      }
    };

    const hareQuota = (V, S) => V / S;
    function largestRemainder(votes, seats, quotaFn, tieBreakRule) {
      const totalVotes = votes.reduce((a, b) => a + b, 0);
      const quota = quotaFn(totalVotes, seats);
      const seatCounts = votes.map(v => Math.floor(v / quota));
      let allocated = seatCounts.reduce((a, b) => a + b, 0);
      const remainders = votes.map((v, i) => v - seatCounts[i] * quota);
      const result = [...seatCounts];
      const disputeList = [];

      while (allocated < seats) {
        let maxRem = Math.max(...remainders);
        const tied = remainders.map((r, i) => r === maxRem ? i : -1).filter(i => i !== -1);
        let chosen = tied.length === 1 ? tied[0] : tieBreakStrategies[tieBreakRule](tied, votes, disputeList, allocated);
        if (chosen === 'DISPUTED') {
          result.push('DISPUTED');
        } else {
          result[chosen]++;
          remainders[chosen] = -1;
        }
        allocated++;
      }
      result.disputedSeats = disputeList;
      return result;
    }

    function buildSVG(title, counts, names, colors) {
      const total = counts.reduce((a, b) => b !== 'DISPUTED' ? a + b : a, 0);
      const disputedCount = counts.filter(c => c === 'DISPUTED').length;
      const totalSeats = total + disputedCount;
      const svg = [`<svg width="800" height="400" xmlns="http://www.w3.org/2000/svg">`];
      svg.push(`<text x="400" y="30" text-anchor="middle" font-size="20">${title}</text>`);

      let angle = Math.PI, radius = 150, cx = 400, cy = 350, r = 10, gap = (Math.PI) / totalSeats;
      let idx = 0;
      counts.forEach((count, i) => {
        if (count === 'DISPUTED') {
          const x = cx + radius * Math.cos(angle);
          const y = cy - radius * Math.sin(angle);
          svg.push(`<circle cx="${x}" cy="${y}" r="${r}" fill="white" stroke="black" />`);
          angle -= gap;
        } else {
          for (let j = 0; j < count; j++) {
            const x = cx + radius * Math.cos(angle);
            const y = cy - radius * Math.sin(angle);
            svg.push(`<circle cx="${x}" cy="${y}" r="${r}" fill="${colors[i]}" stroke="white" />`);
            angle -= gap;
          }
        }
      });

      svg.push(`<rect x="650" y="30" width="15" height="15" fill="white" stroke="black" />`);
      svg.push(`<text x="670" y="43" font-size="12">Disputed seat</text>`);
      return svg.join('\n') + `</svg>`;
    }

    const form = document.getElementById('inputForm');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const totalSeats = parseInt(document.getElementById('totalSeats').value);
      const barrier = parseFloat(document.getElementById('barrier').value) || 0;
      const tieBreakRule = document.getElementById('tieBreakRuleSelect').value;

      const rows = [...tbody.querySelectorAll('tr')];
      const filtered = rows.map(tr => {
        const name = tr.children[0].querySelector('input').value.trim();
        const vote = parseInt(tr.children[1].querySelector('input').value) || 0;
        const color = tr.children[2].querySelector('input').value;
        return { name, vote, color };
      }).filter(p => p.vote > 0);
      if (filtered.length === 0) return alert('All parties have 0 votes');
      const names = filtered.map(p => p.name);
      const votes = filtered.map(p => p.vote);
      const colors = filtered.map(p => p.color);
      const totalVotes = votes.reduce((a, b) => a + b, 0);
      const thresh = totalVotes * barrier / 100;
      const votesFiltered = votes.map(v => v >= thresh ? v : 0);
      if (votesFiltered.reduce((a, b) => a + b, 0) === 0) return alert('No party passed barrier');
      const counts = largestRemainder(votesFiltered, totalSeats, hareQuota, tieBreakRule);
      const svg = buildSVG('Hare Quota with Tie-Breaks', counts, names, colors);
      document.getElementById('results').innerHTML = svg;
    });
  </script>
</body>
</html>
